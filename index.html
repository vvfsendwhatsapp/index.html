<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Selezione VVF</title>

<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 720px;
  margin: 40px auto;
}
label {
  font-weight: bold;
  margin-top: 20px;
  display: block;
}
input {
  width: 100%;
  padding: 8px;
  font-size: 16px;
  margin-top: 5px;
}
button {
  margin-top: 30px;
  padding: 12px 20px;
  font-size: 18px;
  background-color: #25D366;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
button:hover {
  background-color: #128C7E;
}
</style>
</head>

<body>

<h2>Invio dati</h2>

<label for="comando">Comando VVF</label>
<select id="comando" disabled></select>

<label for="prefisso">Prefisso internazionale</label>
<select id="prefisso" disabled></select>

<label for="numero">Numero di telefono</label>
<input type="tel" id="numero" placeholder="Es. 3331234567" inputmode="numeric" pattern="[0-9]*" />

<label for="lingua">Lingua</label>
<select id="lingua"></select>

<button id="whatsappBtn">Apri WhatsApp</button>

<script>
// ================= CONFIG =================
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQ43tX6arNVgy_qw1nWFbCH_OHg-1Y7msl8pnhXzER67OaF2R5onlwHd_a5kMyPI2Uj12olSZnbXB3O/pub?gid=976441910&single=true&output=csv";

// ================= UTILS =================
const parseCSV = csv =>
  csv.trim().split("\n").map(r => r.split(",").map(c => c.trim()));

const buildSelect = (id, options, placeholder, storedValue = null) => {
  const select = document.getElementById(id);
  const frag = document.createDocumentFragment();

  options.forEach(o => {
    const opt = document.createElement("option");
    opt.value = o.value;
    opt.textContent = o.label;
    frag.appendChild(opt);
  });

  select.appendChild(frag);
  select.disabled = false;

  const choices = new Choices(select, {
    searchEnabled: true,
    shouldSort: true,
    itemSelectText: '',
    placeholderValue: placeholder
  });

  if (storedValue) {
    choices.setChoiceByValue(storedValue);
  }

  select.addEventListener("change", () => {
    localStorage.setItem(id, select.value);
  });

  return choices;
};

// ================= LOAD CSV =================
fetch(CSV_URL)
  .then(r => r.text())
  .then(csv => {
    const rows = parseCSV(csv).slice(1);

    // COMANDI (col A)
    const comandi = [...new Set(rows.map(r => r[0]).filter(Boolean))]
      .map(c => ({ value: c, label: c }));
    buildSelect("comando", comandi, "Seleziona comando", localStorage.getItem("comando"));

    // PREFISSI (col B+C)
    const prefissi = rows
      .filter(r => r[1] && r[2])
      .map(r => ({ label: r[1], value: r[2] }));
    buildSelect("prefisso", prefissi, "Seleziona prefisso", localStorage.getItem("prefisso"));
  })
  .catch(err => console.error("Errore CSV:", err));

// ================= VALIDAZIONE NUMERO =================
const numeroInput = document.getElementById("numero");
numeroInput.addEventListener("input", e => {
  e.target.value = e.target.value.replace(/\D/g, "");
  localStorage.setItem("numero", e.target.value);
});
numeroInput.value = localStorage.getItem("numero") || "";

// ================= DROPDOWN LINGUE =================
const lingue = [
  "ITALIANO",
  "ITALIANO Invio Promemoria intervento/chiamata",
  "ITALIANO con GEOLOC",
  "ITALIANO informazioni Comando",
  "ITALIANO Invio coordinate a squadre VF",
  "INGLESE",
  "FRANCESE",
  "TEDESCO",
  "SPAGNOLO",
  "RUSSO",
  "OLANDESE",
  "SLOVENO",
  "SLOVACCO",
  "CINESE",
  "ARABO",
  "ALBANESE"
].map(l => ({ value: l, label: l }));

buildSelect("lingua", lingue, "Seleziona lingua", localStorage.getItem("lingua"));

// ================= PULSANTE WHATSAPP =================
document.getElementById("whatsappBtn").addEventListener("click", () => {
  const comando = document.getElementById("comando").value;
  const prefisso = document.getElementById("prefisso").value;
  const numero = document.getElementById("numero").value;
  const lingua = document.getElementById("lingua").value;

  if (!comando || !prefisso || !numero || !lingua) {
    alert("Compila tutti i campi prima di inviare.");
    return;
  }

  // ======================================
  // Qui inserirai il template del messaggio
  // Ad esempio:
  let messaggio = `Comando: ${comando}\nLingua: ${lingua}\nNumero: ${prefisso}${numero}`;
  // ======================================

  const url = `https://web.whatsapp.com/send?phone=${prefisso}${numero}&text=${encodeURIComponent(messaggio)}`;
  window.open(url, "_blank");
});
</script>

</body>
</html>
